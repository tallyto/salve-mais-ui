<div class="container">
  <div class="header">
    <button mat-icon-button (click)="voltarParaListagem()" class="back-button">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h2>{{ isEditing ? 'Editar' : 'Nova' }} Compra em Débito</h2>
  </div>

  <div class="content">
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon class="title-icon">shopping_cart</mat-icon>
          {{ isEditing ? 'Editar Compra' : 'Registrar Nova Compra' }}
        </mat-card-title>
        <mat-card-subtitle>
          {{ isEditing ? 'Atualize as informações da compra' : 'Registre uma compra que será debitada imediatamente da conta' }}
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="compraDebitoForm" (ngSubmit)="salvarCompraDebito()">
          
          <!-- Informações Básicas -->
          <div class="form-section">
            <h3 class="section-title">
              <mat-icon>info</mat-icon>
              Informações da Compra
            </h3>
            
            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Descrição da Compra</mat-label>
                <input matInput formControlName="nome" placeholder="Ex: Supermercado, Farmácia, etc.">
                <mat-error *ngIf="nome?.hasError('required')">Descrição é obrigatória</mat-error>
                <mat-error *ngIf="nome?.hasError('minlength')">Descrição deve ter pelo menos 3 caracteres</mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Categoria</mat-label>
                <mat-select formControlName="categoriaId">
                  <mat-option value="">Sem categoria</mat-option>
                  <mat-option *ngFor="let categoria of categorias" [value]="categoria.id">
                    {{ categoria.nome }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Conta</mat-label>
                <mat-select formControlName="contaId">
                  <mat-option value="">Selecione uma conta</mat-option>
                  <mat-option *ngFor="let conta of contas" [value]="conta.id">
                    {{ conta.titular }} - Saldo: {{ conta.saldo | currency:'BRL':'symbol':'1.2-2' }}
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="contaId?.hasError('required')">Conta é obrigatória</mat-error>
                <mat-hint *ngIf="isEditing">Não é possível alterar a conta</mat-hint>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Data da Compra</mat-label>
                <input matInput type="date" formControlName="dataCompra">
                <mat-error *ngIf="dataCompra?.hasError('required')">Data da compra é obrigatória</mat-error>
                <mat-hint *ngIf="isEditing">Não é possível alterar a data</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>Valor</mat-label>
                <input matInput type="text" formControlName="valor" placeholder="0.00" appCurrencyInput>
                <span matTextPrefix>R$ </span>
                <mat-error *ngIf="valor?.hasError('required')">Valor é obrigatório</mat-error>
                <mat-error *ngIf="valor?.hasError('min')">Valor deve ser maior que zero</mat-error>
                <mat-hint *ngIf="isEditing">Não é possível alterar o valor</mat-hint>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Observações (Opcional)</mat-label>
                <textarea matInput formControlName="observacoes" rows="3" 
                          placeholder="Informações adicionais sobre esta compra..."></textarea>
              </mat-form-field>
            </div>
          </div>

          <!-- Alerta -->
          <div class="alert-section" *ngIf="!isEditing">
            <mat-icon class="alert-icon">info</mat-icon>
            <div class="alert-content">
              <strong>Atenção:</strong> Ao registrar esta compra, o valor será <strong>debitado imediatamente</strong> 
              da conta selecionada e uma transação será criada automaticamente.
            </div>
          </div>

          <div class="alert-section warning" *ngIf="isEditing">
            <mat-icon class="alert-icon">warning</mat-icon>
            <div class="alert-content">
              <strong>Limitação de Edição:</strong> Não é possível alterar o valor, conta ou data de uma compra já registrada, 
              pois o débito já foi realizado.
            </div>
          </div>

        </form>
      </mat-card-content>

      <mat-card-actions align="end">
        <button mat-button type="button" (click)="voltarParaListagem()" [disabled]="loading">
          Cancelar
        </button>
        <button mat-raised-button color="primary" (click)="salvarCompraDebito()" 
                [disabled]="loading || compraDebitoForm.invalid">
          <mat-icon *ngIf="!loading">{{ isEditing ? 'save' : 'shopping_cart' }}</mat-icon>
          <mat-spinner *ngIf="loading" diameter="20" class="button-spinner"></mat-spinner>
          {{ loading ? 'Salvando...' : (isEditing ? 'Atualizar' : 'Registrar Compra') }}
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
</div>
