<!-- Filtros de Mês e Ano -->
<div class="filters-container">
  <div class="filters-header">
    <h3 class="filters-title">{{ getSelectedPeriodText() }}</h3>
    
    <!-- Navegação Rápida -->
    <div class="period-navigation">
      <button mat-icon-button matTooltip="Mês anterior" (click)="previousMonth()">
        <mat-icon>chevron_left</mat-icon>
      </button>
      <button mat-icon-button matTooltip="Próximo mês" (click)="nextMonth()">
        <mat-icon>chevron_right</mat-icon>
      </button>
    </div>
  </div>

  <div class="filters-row">
    <!-- Seleção de Mês e Ano -->
    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Mês</mat-label>
      <mat-select [(value)]="selectedMonth" (selectionChange)="onFilterChange()">
        <mat-option *ngFor="let month of months" [value]="month.value">
          {{ month.label }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Ano</mat-label>
      <mat-select [(value)]="selectedYear" (selectionChange)="onFilterChange()">
        <mat-option *ngFor="let year of years" [value]="year">
          {{ year }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Atalhos Rápidos -->
    <div class="quick-filters">
      <button 
        mat-button 
        (click)="resetFilters()" 
        [class.active]="isCurrentMonth()">
        Hoje
      </button>
      <button 
        mat-button 
        (click)="setLastMonth()" 
        [class.active]="isLastMonth()">
        Mês Passado
      </button>
      <button 
        mat-button 
        (click)="setNextMonth()" 
        [class.active]="isNextMonth()">
        Próximo
      </button>
    </div>
  </div>
</div>

<div class="table-container">
  <table [dataSource]="contasFixas" matSortActive="id" mat-table matSort matSortDisableClear matSortDirection="desc" class="expense-table">

    <!-- Nome Column -->
    <ng-container matColumnDef="nome">
      <th *matHeaderCellDef mat-header-cell mat-sort-header> Nome</th>
      <td *matCellDef="let contaFixa" mat-cell> {{ contaFixa.nome }}</td>
    </ng-container>

    <!-- Categoria Column -->
    <ng-container matColumnDef="categoria">
      <th *matHeaderCellDef mat-header-cell mat-sort-header> Categoria</th>
      <td *matCellDef="let contaFixa" mat-cell>
        {{ contaFixa.categoria ? contaFixa.categoria.nome : 'N/A' }}
      </td>
    </ng-container>

    <!-- Account Column -->
    <ng-container matColumnDef="conta">
      <th *matHeaderCellDef mat-header-cell mat-sort-header>Conta</th>
      <td *matCellDef="let contaFixa" mat-cell> {{ contaFixa.conta.titular }}</td>
    </ng-container>

    <!-- Vencimento Column -->
    <ng-container matColumnDef="vencimento">
      <th *matHeaderCellDef mat-header-cell mat-sort-header> Vencimento</th>
      <td *matCellDef="let contaFixa" mat-cell> {{ contaFixa.vencimento | date:'dd/MM/yyyy' }}</td>
    </ng-container>

    <!-- Valor Column -->
    <ng-container matColumnDef="valor">
      <th *matHeaderCellDef mat-header-cell mat-sort-header> Valor</th>
      <td *matCellDef="let contaFixa" mat-cell class="expense-value" [ngClass]="{'unpaid': !contaFixa.pago, 'paid': contaFixa.pago}">
        {{ contaFixa.valor | currency:'BRL':'symbol':'1.2-2' }}
      </td>
    </ng-container>

    <!-- Pago Column -->
    <ng-container matColumnDef="pago">
      <th *matHeaderCellDef mat-header-cell class="text-center"> Status</th>
      <td *matCellDef="let contaFixa" mat-cell class="text-center">
        <span class="status-badge" [ngClass]="contaFixa.pago ? 'status-paid' : 'status-pending'">
          {{ contaFixa.pago ? 'Pago' : 'Pendente' }}
        </span>
      </td>
    </ng-container>

    <!-- Ações Column -->
    <ng-container matColumnDef="acoes">
      <th *matHeaderCellDef mat-header-cell class="text-right"> Ações</th>
      <td *matCellDef="let contaFixa" mat-cell class="text-right">
        <div class="action-buttons">
          <!-- Ações Principais (sempre visíveis) -->
          <button 
            mat-icon-button 
            [color]="contaFixa.pago ? 'disabled' : 'primary'" 
            [matTooltip]="contaFixa.pago ? 'Já está pago' : 'Pagar conta'" 
            (click)="pagarContaFixa(contaFixa)"
            [disabled]="contaFixa.pago">
            <mat-icon>payments</mat-icon>
          </button>
          
          <button 
            mat-icon-button 
            color="primary" 
            matTooltip="Editar despesa" 
            (click)="startEdit(contaFixa)">
            <mat-icon>edit</mat-icon>
          </button>
          
          <!-- Menu de Mais Opções -->
          <button mat-icon-button [matMenuTriggerFor]="moreMenu" matTooltip="Mais opções">
            <mat-icon>more_vert</mat-icon>
          </button>
          
          <mat-menu #moreMenu="matMenu">
            <button mat-menu-item (click)="abrirComprovantes(contaFixa)">
              <mat-icon color="accent">attach_file</mat-icon>
              <span>Comprovantes</span>
            </button>
            
            <button mat-menu-item (click)="recriarDespesaProximoMes(contaFixa)">
              <mat-icon color="accent">event_repeat</mat-icon>
              <span>Lançar no próximo mês</span>
            </button>
            
            <mat-divider></mat-divider>
            
            <button mat-menu-item (click)="excluirDespesa(contaFixa)">
              <mat-icon color="warn">delete</mat-icon>
              <span class="text-warn">Excluir despesa</span>
            </button>
          </mat-menu>
        </div>
      </td>
    </ng-container>

    <tr *matHeaderRowDef="displayedColumnsContasFixas" mat-header-row></tr>
    <tr *matRowDef="let row; columns: displayedColumnsContasFixas;" mat-row></tr>
  </table>
</div>

<mat-paginator [length]="resultsLength" [pageSizeOptions]="[5, 10, 20]" [pageSize]="10"></mat-paginator>

<div *ngIf="contasFixas.length === 0" class="empty-state">
  <mat-icon>payments</mat-icon>
  <p>Nenhuma despesa fixa encontrada para {{ getSelectedPeriodText() }}.</p>
  <p>Selecione outro período ou adicione uma nova despesa.</p>
</div>
