<!-- Header -->
<div class="page-header">
  <div class="header-content">
    <mat-icon class="page-icon">history</mat-icon>
    <div class="flex-1">
      <h1 class="page-title">Histórico de Transações</h1>
      <p class="page-subtitle">Visualize todas as suas movimentações financeiras</p>
    </div>
  </div>
</div>

<!-- Filtros -->
<div class="content-card">
  <div class="card-header">
    <div class="header-title">
      <mat-icon>filter_list</mat-icon>
      <h2 class="section-title">Filtros</h2>
    </div>
  </div>
  <div class="form-container">
    <form [formGroup]="filtroForm" (ngSubmit)="aplicarFiltro()">
      <div class="grid">
        <div class="col-12 md:col-6 lg:col-3 mb-3">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Conta</mat-label>
            <mat-select formControlName="contaId">
              <mat-option [value]="null">Todas as contas</mat-option>
              <mat-option *ngFor="let conta of contas" [value]="conta.id">
                {{ conta.nome }}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>account_balance</mat-icon>
          </mat-form-field>
        </div>

        <div class="col-12 md:col-6 lg:col-3 mb-3">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Tipo</mat-label>
            <mat-select formControlName="tipo">
              <mat-option [value]="null">Todos os tipos</mat-option>
              <mat-option value="CREDITO" class="tipo-option receita">
                <span class="tipo-option-content receita">
                  <mat-icon>arrow_upward</mat-icon>
                  Entrada (Crédito)
                </span>
              </mat-option>
              <mat-option value="DEBITO" class="tipo-option despesa">
                <span class="tipo-option-content despesa">
                  <mat-icon>arrow_downward</mat-icon>
                  Saída (Débito)
                </span>
              </mat-option>
              <mat-option value="TRANSFERENCIA_ENTRADA" class="tipo-option receita">
                <span class="tipo-option-content receita">
                  <mat-icon>swap_horiz</mat-icon>
                  Transferência Entrada
                </span>
              </mat-option>
              <mat-option value="TRANSFERENCIA_SAIDA" class="tipo-option despesa">
                <span class="tipo-option-content despesa">
                  <mat-icon>swap_horiz</mat-icon>
                  Transferência Saída
                </span>
              </mat-option>
              <mat-option value="PAGAMENTO_FATURA" class="tipo-option despesa">
                <span class="tipo-option-content despesa">
                  <mat-icon>credit_card</mat-icon>
                  Pagamento Fatura
                </span>
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>swap_vert</mat-icon>
          </mat-form-field>
        </div>

        <div class="col-12 md:col-6 lg:col-3 mb-3">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Categoria</mat-label>
            <mat-select formControlName="categoriaId">
              <mat-option [value]="null">Todas as categorias</mat-option>
              <mat-option *ngFor="let categoria of categorias" [value]="categoria.id">
                {{ categoria.nome }}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>category</mat-icon>
          </mat-form-field>
        </div>

        <div class="col-12 md:col-6 lg:col-3 mb-3">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Data Início</mat-label>
            <input matInput [matDatepicker]="pickerInicio" formControlName="dataInicio">
            <mat-datepicker-toggle matIconSuffix [for]="pickerInicio"></mat-datepicker-toggle>
            <mat-datepicker #pickerInicio></mat-datepicker>
          </mat-form-field>
        </div>

        <div class="col-12 md:col-6 lg:col-3 mb-3">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Data Fim</mat-label>
            <input matInput [matDatepicker]="pickerFim" formControlName="dataFim">
            <mat-datepicker-toggle matIconSuffix [for]="pickerFim"></mat-datepicker-toggle>
            <mat-datepicker #pickerFim></mat-datepicker>
          </mat-form-field>
        </div>
      </div>

      <div class="form-actions">
        <button mat-stroked-button type="button" (click)="limparFiltro()">
          <mat-icon>clear</mat-icon>
          Limpar Filtros
        </button>
        <button mat-raised-button color="primary" type="submit">
          <mat-icon>search</mat-icon>
          Aplicar Filtros
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Tabela de Transações -->
<div class="content-card">
  <div class="card-header">
    <div class="header-title">
      <mat-icon>receipt_long</mat-icon>
      <h2 class="section-title">Movimentações</h2>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-state">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Carregando transações...</p>
  </div>

  <!-- Tabela -->
  <div *ngIf="!loading" class="table-container">
    <table mat-table [dataSource]="transacoes" class="data-table">
      <!-- Data Column -->
      <ng-container matColumnDef="data">
        <th mat-header-cell *matHeaderCellDef>Data</th>
        <td mat-cell *matCellDef="let transacao">
          {{ transacao.data | date: 'dd/MM/yyyy' }}
        </td>
      </ng-container>

      <!-- Tipo Column -->
      <ng-container matColumnDef="tipo">
        <th mat-header-cell *matHeaderCellDef>Tipo</th>
        <td mat-cell *matCellDef="let transacao">
          <span class="tipo-badge" 
                [class.receita]="isEntrada(transacao.tipo)" 
                [class.despesa]="isSaida(transacao.tipo)">
            <mat-icon>{{ getTipoIcon(transacao.tipo) }}</mat-icon>
            {{ getTipoTransacaoLabel(transacao.tipo) }}
          </span>
        </td>
      </ng-container>

      <!-- Descrição Column -->
      <ng-container matColumnDef="descricao">
        <th mat-header-cell *matHeaderCellDef>Descrição</th>
        <td mat-cell *matCellDef="let transacao">{{ transacao.descricao }}</td>
      </ng-container>

      <!-- Valor Column -->
      <ng-container matColumnDef="valor">
        <th mat-header-cell *matHeaderCellDef class="text-right">Valor</th>
        <td mat-cell *matCellDef="let transacao" class="text-right">
          <span class="valor-text" 
                [class.receita]="isEntrada(transacao.tipo)" 
                [class.despesa]="isSaida(transacao.tipo)">
            {{ transacao.valor | currency: 'BRL' }}
          </span>
        </td>
      </ng-container>

      <!-- Conta Column -->
      <ng-container matColumnDef="conta">
        <th mat-header-cell *matHeaderCellDef>Conta</th>
        <td mat-cell *matCellDef="let transacao">
          {{ transacao.conta?.nome || '-' }}
        </td>
      </ng-container>

      <!-- Categoria Column -->
      <ng-container matColumnDef="categoria">
        <th mat-header-cell *matHeaderCellDef>Categoria</th>
        <td mat-cell *matCellDef="let transacao">
          {{ transacao.categoria?.nome || '-' }}
        </td>
      </ng-container>

      <!-- Ações Column -->
      <ng-container matColumnDef="acoes">
        <th mat-header-cell *matHeaderCellDef class="text-right">Ações</th>
        <td mat-cell *matCellDef="let transacao" class="text-right">
          <button mat-icon-button [matMenuTriggerFor]="menu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item [routerLink]="['/transacoes/editar', transacao.id]">
              <mat-icon>edit</mat-icon>
              <span>Editar</span>
            </button>
            <button mat-menu-item (click)="excluirTransacao(transacao.id)">
              <mat-icon color="warn">delete</mat-icon>
              <span>Excluir</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      <!-- Empty state -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          <div class="empty-state">
            <mat-icon>search_off</mat-icon>
            <p>Nenhuma transação encontrada</p>
            <small>Tente ajustar os filtros ou adicionar novas transações</small>
          </div>
        </td>
      </tr>
    </table>

    <!-- Paginação -->
    <mat-paginator 
      [length]="totalElements"
      [pageSize]="pageSize"
      [pageIndex]="pageIndex"
      [pageSizeOptions]="[5, 10, 25, 50]"
      (page)="mudarPagina($event)"
      showFirstLastButtons>
    </mat-paginator>
  </div>
</div>