<div class="dashboard-container">
  <div class="header">
    <div class="header-content">
      <mat-icon class="header-icon">dashboard</mat-icon>
      <div class="header-text">
        <h2 class="page-title">Dashboard Financeiro</h2>
        <div class="dashboard-date text-color-secondary">
          <mat-icon>today</mat-icon> {{ today | date:'dd/MM/yyyy' }} - Visão geral da sua situação financeira
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="isLoading" class="loading-overlay">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <!-- Financial Summary -->
  <div class="grid mb-4">
    <div class="col-12 md:col-6 lg:col-3 mb-3">
      <div class="summary-card" style="border-top-color: #4caf50;">
        <div class="card-icon" style="background-color: rgba(76, 175, 80, 0.1); color: #4caf50;">
          <mat-icon>account_balance_wallet</mat-icon>
        </div>
        <div class="summary-label">Saldo Total</div>
        <div class="summary-value positive">{{ totalSaldo | currency:'BRL':'symbol':'1.2-2' }}</div>
        <div class="text-color-secondary" *ngIf="summaryData && summaryData.saldoMesAnterior !== undefined">
          <small>
            <mat-icon *ngIf="totalSaldo > summaryData.saldoMesAnterior">trending_up</mat-icon>
            <mat-icon *ngIf="totalSaldo < summaryData.saldoMesAnterior">trending_down</mat-icon>
            <mat-icon *ngIf="totalSaldo === summaryData.saldoMesAnterior">trending_flat</mat-icon>
            {{ (totalSaldo / summaryData.saldoMesAnterior - 1) * 100 | number:'1.1-1' }}% vs mês anterior
          </small>
        </div>
      </div>
    </div>

    <div class="col-12 md:col-6 lg:col-3 mb-3">
      <div class="summary-card" style="border-top-color: #4caf50;">
        <div class="card-icon" style="background-color: rgba(76, 175, 80, 0.1); color: #4caf50;">
          <mat-icon>trending_up</mat-icon>
        </div>
        <div class="summary-label">Receitas do Mês</div>
        <div class="summary-value positive">{{ totalReceitas | currency:'BRL':'symbol':'1.2-2' }}</div>
        <div class="text-color-secondary" *ngIf="monthlyTrendData && monthlyTrendData.length > 1">
          <small>
            {{ totalReceitas / totalDespesas | number:'1.1-1' }}x das despesas
          </small>
        </div>
      </div>
    </div>

    <div class="col-12 md:col-6 lg:col-3 mb-3">
      <div class="summary-card" style="border-top-color: #f44336;">
        <div class="card-icon" style="background-color: rgba(244, 67, 54, 0.1); color: #f44336;">
          <mat-icon>trending_down</mat-icon>
        </div>
        <div class="summary-label">Despesas do Mês</div>
        <div class="summary-value negative">{{ totalDespesas | currency:'BRL':'symbol':'1.2-2' }}</div>
        <div class="text-color-secondary" *ngIf="summaryData">
          <small>
            {{ (totalDespesas / totalReceitas) * 100 | number:'1.1-1' }}% da receita
          </small>
        </div>
      </div>
    </div>

    <div class="col-12 md:col-6 lg:col-3 mb-3">
      <div class="summary-card" style="border-top-color: #ff9800;">
        <div class="card-icon" style="background-color: rgba(255, 152, 0, 0.1); color: #ff9800;">
          <mat-icon>savings</mat-icon>
        </div>
        <div class="summary-label">Reserva de Emergência</div>
        <div class="summary-value" *ngIf="summaryData && summaryData.reservaEmergencia && summaryData.reservaEmergencia.saldoAtual !== undefined">
          {{ summaryData.reservaEmergencia.saldoAtual | currency:'BRL':'symbol':'1.2-2' }}
        </div>
        <div class="summary-value" *ngIf="!summaryData || !summaryData.temReservaEmergencia || !summaryData.reservaEmergencia">
          Não configurada
        </div>
        <div class="text-color-secondary" *ngIf="summaryData && summaryData.reservaEmergencia && summaryData.reservaEmergencia.percentualConcluido !== undefined">
          <small>
            {{ summaryData.reservaEmergencia.percentualConcluido | number:'1.1-1' }}% da meta
            <a routerLink="/reserva-emergencia" class="small-link">Ver detalhes</a>
          </small>
        </div>
        <div class="text-color-secondary" *ngIf="!summaryData || !summaryData.temReservaEmergencia || !summaryData.reservaEmergencia">
          <small>
            <a routerLink="/reserva-emergencia/criar" class="small-link">Configurar reserva</a>
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Accounts Summary -->
  <div class="grid mb-4">
    <div class="col-12 md:col-6 lg:col-3 mb-3">
      <div class="summary-card" style="border-top-color: #9c27b0;">
        <div class="card-icon" style="background-color: rgba(156, 39, 176, 0.1); color: #9c27b0;">
          <mat-icon>account_balance</mat-icon>
        </div>
        <div class="summary-label">Contas Bancárias</div>
        <div class="summary-value">{{ accounts.length }}</div>
        <div class="text-color-secondary">
          <small>
            {{ accounts.length > 0 ? (totalSaldo / accounts.length | currency:'BRL':'symbol':'1.0-0') + ' média' : 'Nenhuma conta' }}
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Parcelas Summary -->
  <div class="section-header mb-3" *ngIf="summaryData && summaryData.parcelasResumo">
    <h2>Compras Parceladas</h2>
  </div>
  <div class="grid mb-4" *ngIf="summaryData && summaryData.parcelasResumo">
    <div class="col-12 md:col-6 lg:col-3 mb-3">
      <div class="summary-card" style="border-top-color: #2196f3;">
        <div class="card-icon" style="background-color: rgba(33, 150, 243, 0.1); color: #2196f3;">
          <mat-icon>shopping_cart</mat-icon>
        </div>
        <div class="summary-label">Parcelas Ativas</div>
        <div class="summary-value">{{ summaryData.parcelasResumo.totalParcelasAtivas }}</div>
        <div class="text-color-secondary">
          <small>
            <a routerLink="/compras-parceladas" class="small-link">Ver todas</a>
          </small>
        </div>
      </div>
    </div>

    <div class="col-12 md:col-6 lg:col-3 mb-3">
      <div class="summary-card" style="border-top-color: #4caf50;">
        <div class="card-icon" style="background-color: rgba(76, 175, 80, 0.1); color: #4caf50;">
          <mat-icon>check_circle</mat-icon>
        </div>
        <div class="summary-label">Pagas no Mês</div>
        <div class="summary-value">{{ summaryData.parcelasResumo.parcelasPagasMes }}</div>
        <div class="text-color-secondary">
          <small>
            {{ summaryData.parcelasResumo.valorPagoMes | currency:'BRL':'symbol':'1.2-2' }}
          </small>
        </div>
      </div>
    </div>

    <div class="col-12 md:col-6 lg:col-3 mb-3">
      <div class="summary-card" style="border-top-color: #ff9800;">
        <div class="card-icon" style="background-color: rgba(255, 152, 0, 0.1); color: #ff9800;">
          <mat-icon>pending</mat-icon>
        </div>
        <div class="summary-label">Pendentes no Mês</div>
        <div class="summary-value">{{ summaryData.parcelasResumo.parcelasNaoPagasMes }}</div>
        <div class="text-color-secondary">
          <small>
            {{ summaryData.parcelasResumo.valorRestanteMes | currency:'BRL':'symbol':'1.2-2' }}
          </small>
        </div>
      </div>
    </div>

    <div class="col-12 md:col-6 lg:col-3 mb-3">
      <div class="summary-card" style="border-top-color: #9c27b0;">
        <div class="card-icon" style="background-color: rgba(156, 39, 176, 0.1); color: #9c27b0;">
          <mat-icon>payment</mat-icon>
        </div>
        <div class="summary-label">Total do Mês</div>
        <div class="summary-value">{{ summaryData.parcelasResumo.valorTotalParcelasMes | currency:'BRL':'symbol':'1.2-2' }}</div>
        <div class="text-color-secondary">
          <small>
            {{ summaryData.parcelasResumo.parcelasPagasMes + summaryData.parcelasResumo.parcelasNaoPagasMes }} parcelas
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="section-header mb-3">
    <h2>Análise Financeira</h2>
  </div>
  <div class="grid mt-4 mb-4">
    <!-- Expenses by Category Chart -->
    <div class="col-12 lg:col-4 p-2 mb-3">
      <div class="data-card h-full" style="border-top-color: #f44336;">
        <div class="card-header">
          <div class="header-title">
            <mat-icon style="color: #f44336; margin-right: 8px;">pie_chart</mat-icon>
            <h2 class="section-title m-0">Despesas por Categoria</h2>
          </div>
        </div>
        <div class="card-content chart-container">
          <canvas baseChart
            [data]="pieChartData"
            [options]="pieChartOptions"
            [type]="'pie'">
          </canvas>
        </div>
      </div>
    </div>

    <!-- Income vs Expenses Chart -->
    <div class="col-12 lg:col-4 p-2 mb-3">
      <div class="data-card h-full" style="border-top-color: #4caf50;">
        <div class="card-header">
          <div class="header-title">
            <mat-icon style="color: #4caf50; margin-right: 8px;">bar_chart</mat-icon>
            <h2 class="section-title m-0">Receitas vs Despesas</h2>
          </div>
        </div>
        <div class="card-content chart-container">
          <canvas baseChart
            [data]="barChartData"
            [options]="barChartOptions"
            [type]="'bar'">
          </canvas>
        </div>
      </div>
    </div>

    <!-- Monthly Trend Chart -->
    <div class="col-12 lg:col-4 p-2 mb-3">
      <div class="data-card h-full" style="border-top-color: #2196f3;">
        <div class="card-header">
          <div class="header-title">
            <mat-icon style="color: #2196f3; margin-right: 8px;">trending_up</mat-icon>
            <h2 class="section-title m-0">Tendência Mensal</h2>
          </div>
        </div>
        <div class="card-content chart-container">
          <canvas baseChart
            [data]="lineChartData"
            [options]="lineChartOptions"
            [type]="'line'">
          </canvas>
        </div>
      </div>
    </div>

    <!-- Limites dos Cartões Widget -->
    <div class="col-12 lg:col-4 p-2 mb-3">
      <app-limite-alertas-widget></app-limite-alertas-widget>
    </div>

    <!-- Notificações Widget -->
    <div class="col-12 lg:col-4 p-2 mb-3">
      <app-notificacoes-widget></app-notificacoes-widget>
    </div>
  </div>

  <!-- Variation Table Section -->
  <div class="section-header mb-3">
    <h2>Variação Mensal</h2>
  </div>
  <div class="col-12 mt-3 p-2 mb-4">
    <div class="data-card" style="border-top-color: #ff9800;">
      <div class="card-header">
        <div class="header-title">
          <mat-icon style="color: #ff9800; margin-right: 8px;">compare_arrows</mat-icon>
          <h2 class="section-title m-0">Comparativo com o Mês Anterior</h2>
        </div>
      </div>
      <div class="card-content">
        <div class="variation-table-container">
          <table class="variation-table w-full">
            <thead>
              <tr>
                <th class="text-left">Métrica</th>
                <th class="text-right">Mês Atual</th>
                <th class="text-right">Mês Anterior</th>
                <th class="text-right">Variação</th>
                <th class="text-center">Tendência</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let variation of variationData" class="variation-row">
                <td class="metric-cell">
                  <div class="metric-info">
                    <mat-icon class="metric-icon">{{ variation.icon }}</mat-icon>
                    <span class="metric-name">{{ variation.metric }}</span>
                  </div>
                </td>
                <td class="text-right">
                  <span class="current-value">
                    {{ variation.currentValue | currency:'BRL':'symbol':'1.2-2' }}
                  </span>
                </td>
                <td class="text-right">
                  <span class="previous-value">
                    {{ variation.previousValue | currency:'BRL':'symbol':'1.2-2' }}
                  </span>
                </td>
                <td class="text-right">
                  <div class="variation-info">
                    <div class="variation-amount" [ngClass]="getVariationTrendClass(variation.trend)">
                      {{ variation.variation | currency:'BRL':'symbol':'1.2-2' }}
                    </div>
                    <div class="variation-percent" [ngClass]="getVariationTrendClass(variation.trend)">
                      {{ variation.variationPercent | number:'1.1-1' }}%
                    </div>
                  </div>
                </td>
                <td class="text-center">
                  <div class="trend-indicator" [ngClass]="getVariationTrendClass(variation.trend)">
                    <mat-icon>{{ getVariationIcon(variation.trend) }}</mat-icon>
                  </div>
                </td>
              </tr>
              <tr *ngIf="variationData.length === 0">
                <td colspan="5" class="text-center p-4 text-color-secondary">
                  <mat-icon>info</mat-icon>
                  <span class="ml-2">Dados de variação não disponíveis</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Card Purchases -->
  <div class="section-header mb-3">
    <h2>Compras no Cartão</h2>
  </div>
  <div class="col-12 mt-3 p-2">
    <div class="data-card" style="border-top-color: #9c27b0;">
      <div class="card-header">
        <div class="header-title">
          <mat-icon style="color: #9c27b0; margin-right: 8px;">credit_card</mat-icon>
          <h2 class="section-title m-0">Últimas Compras</h2>
        </div>
        <span class="text-color-secondary">Últimos 5 lançamentos</span>
      </div>
      <div class="card-content">
        <table class="transaction-table w-full">
          <thead>
            <tr>
              <th>Descrição</th>
              <th>Data</th>
              <th>Categoria</th>
              <th>Cartão</th>
              <th class="text-right">Valor</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let transaction of recentTransactions">
              <td>
                <div class="transaction-description">
                  <span class="transaction-icon card-bg">
                    <mat-icon>credit_card</mat-icon>
                  </span>
                  {{ transaction.descricao }}
                </div>
              </td>
              <td>{{ transaction.data | date:'dd/MM/yyyy' }}</td>
              <td>
                <span class="category-tag">
                  {{ transaction.categoria?.nome || 'Não categorizada' }}
                </span>
              </td>
              <td>
                <span class="card-tag" *ngIf="transaction.cartao">
                  {{ transaction.cartao.nome }}
                </span>
                <span *ngIf="!transaction.cartao">-</span>
              </td>
              <td class="text-right negative">
                {{ transaction.valor | currency:'BRL':'symbol':'1.2-2' }}
              </td>
            </tr>
            <tr *ngIf="recentTransactions.length === 0">
              <td colspan="5" class="text-center p-4 text-color-secondary">
                Nenhuma compra no cartão encontrada.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Financial Health Indicators -->
  <div class="section-header mb-3">
    <h2>Saúde Financeira e Contas</h2>
  </div>
  <div class="grid mt-3">
    <div class="col-12 lg:col-6 p-2 mb-3">
      <div class="data-card h-full" style="border-top-color: #4caf50;">
        <div class="card-header">
          <div class="header-title">
            <mat-icon style="color: #4caf50; margin-right: 8px;">health_and_safety</mat-icon>
            <h2 class="section-title m-0">Saúde Financeira</h2>
          </div>
        </div>
        <div class="card-content">
          <div class="health-summary mb-3">
            <div class="health-status" [ngClass]="getBalanceHealthClass()">
              <div class="health-icon">
                <mat-icon *ngIf="getBalanceRatio() >= 75">sentiment_very_satisfied</mat-icon>
                <mat-icon *ngIf="getBalanceRatio() >= 50 && getBalanceRatio() < 75">sentiment_satisfied</mat-icon>
                <mat-icon *ngIf="getBalanceRatio() >= 25 && getBalanceRatio() < 50">sentiment_dissatisfied</mat-icon>
                <mat-icon *ngIf="getBalanceRatio() < 25">sentiment_very_dissatisfied</mat-icon>
              </div>
              <div class="health-value">{{ formatarPercentual(getBalanceRatio()) }}</div>
            </div>
            <div class="health-text">
              <h3>
                <span *ngIf="getBalanceRatio() >= 75">Excelente</span>
                <span *ngIf="getBalanceRatio() >= 50 && getBalanceRatio() < 75">Boa</span>
                <span *ngIf="getBalanceRatio() >= 25 && getBalanceRatio() < 50">Média</span>
                <span *ngIf="getBalanceRatio() < 25">Preocupante</span>
              </h3>
              <p>Proporção entre saldo e despesas mensais</p>
            </div>
          </div>
          <div class="progress-container mb-3">
            <div class="progress-label">
              <span>Saldo vs Despesas</span>
              <span>{{ formatarPercentual(getBalanceRatio()) }}</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width]="getBalanceRatio() + '%'" [ngClass]="getBalanceHealthClass()"></div>
            </div>
          </div>
          <div class="financial-tip">
            <mat-icon>lightbulb</mat-icon>
            <div>
              <p class="tip-title">Dica Financeira</p>
              <p class="tip-text">{{ getFinancialTip() }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reserva de Emergência Detalhada -->
    <div class="col-12 lg:col-6 p-2 mb-3">
      <div class="data-card h-full" style="border-top-color: #ff9800;">
        <div class="card-header">
          <div class="header-title">
            <mat-icon style="color: #ff9800; margin-right: 8px;">savings</mat-icon>
            <h2 class="section-title m-0">Reserva de Emergência</h2>
          </div>
        </div>
        <div class="card-content">
          <div *ngIf="summaryData && summaryData.reservaEmergencia && summaryData.temReservaEmergencia">
            <div class="health-summary mb-3">
              <div class="health-status" [ngClass]="getReservaEmergenciaHealthClass()">
                <div class="health-icon">
                  <mat-icon>{{ getReservaEmergenciaIcon() }}</mat-icon>
                </div>
                <div class="health-value">{{ getReservaEmergenciaPercentual() | number:'1.1-1' }}%</div>
              </div>
              <div class="health-text">
                <h3>{{ getReservaEmergenciaStatus() }}</h3>
                <p *ngIf="summaryData?.reservaEmergencia?.objetivo">Objetivo: {{ summaryData.reservaEmergencia.objetivo | currency:'BRL':'symbol':'1.2-2' }}</p>
              </div>
            </div>
            <div class="progress-container mb-3">
              <div class="progress-label">
                <span>Progresso</span>
                <span>{{ getReservaEmergenciaPercentual() | number:'1.1-1' }}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" [style.width]="getReservaEmergenciaPercentual() + '%'" [ngClass]="getReservaEmergenciaHealthClass()"></div>
              </div>
            </div>
            <div class="financial-tip">
              <mat-icon>lightbulb</mat-icon>
              <div>
                <p class="tip-title">Informações</p>
                <p class="tip-text" *ngIf="!reservaEmergenciaEstaCompleta() && getReservaEmergenciaTempoRestante()">
                  Faltam aproximadamente {{ getReservaEmergenciaTempoRestante() }} meses para completar sua reserva.
                </p>
                <p class="tip-text" *ngIf="reservaEmergenciaEstaCompleta()">
                  Sua reserva de emergência está completa! Considere investir o excedente.
                </p>
                <div class="account-add-button">
                  <button mat-button color="primary" [routerLink]="['/reserva-emergencia']">
                    <mat-icon>visibility</mat-icon> Ver detalhes
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="!summaryData || !summaryData.temReservaEmergencia || !summaryData.reservaEmergencia" class="text-center p-4">
            <p class="mb-3 text-color-secondary">Você ainda não configurou sua reserva de emergência.</p>
            <p class="mb-3">Uma reserva de emergência é fundamental para sua segurança financeira. Recomenda-se ter entre 3 a 6 meses de despesas guardados.</p>
            <button mat-raised-button color="primary" [routerLink]="['/reserva-emergencia/criar']">
              <mat-icon>add_circle_outline</mat-icon> Configurar reserva
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 lg:col-6 p-2 mb-3">
      <div class="data-card h-full" style="border-top-color: #2196f3;">
        <div class="card-header">
          <div class="header-title">
            <mat-icon style="color: #2196f3; margin-right: 8px;">account_balance</mat-icon>
            <h2 class="section-title m-0">Resumo de Contas</h2>
          </div>
        </div>
        <div class="card-content">
          <div *ngFor="let account of accounts" class="account-item">
            <div class="account-info">
              <div class="account-name">{{ account.titular }}</div>
              <div class="account-balance" [ngClass]="{'positive': account.saldo > 0, 'negative': account.saldo < 0}">{{ account.saldo | currency:'BRL':'symbol':'1.2-2' }}</div>
            </div>
          </div>
          <div *ngIf="accounts.length === 0" class="text-center p-4 text-color-secondary">
            Nenhuma conta cadastrada
          </div>
          <div *ngIf="accounts.length > 0" class="account-add-button">
            <button mat-button color="primary" [routerLink]="['/account']">
              <mat-icon>add_circle_outline</mat-icon> Gerenciar contas
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
